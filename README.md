# Coordinate-systems-LB-No.-5
Обробка координатних даних: Придушення шумів у потоці (Real-time)

## Реалізація фільтрів

### 1. SMA (Simple Moving Average)

```python
class SMAFilter:
    def __init__(self, w):
        self.w = w
        self.q = deque(maxlen=w)
        self.sum = 0.0
    
    def update(self, x):
        if len(self.q) == self.w:
            self.sum -= self.q[0]
        self.q.append(x)
        self.sum += x
        return self.sum / len(self.q)
```

**Особливості:** Оптимізація O(1) за допомогою підтримки суми. Добре давить Гауссів шум, але розмазує різкі зміни траєкторії.

### 2. EMA (Exponential Moving Average)

```python
class EMAFilter:
    def __init__(self, alpha):
        self.a = alpha
        self.last = None
    
    def update(self, x):
        if self.last is None:
            self.last = x
            return x
        self.last = self.a * x + (1 - self.a) * self.last
        return self.last
```

**Особливості:** Рекурсивний фільтр, мінімальне використання пам'яті. Швидше реагує на зміни порівняно з SMA при еквівалентних параметрах.

### 3. Median Filter

```python
class MedianFilter:
    def __init__(self, w):
        if w % 2 == 0:
            w += 1
        self.w = w
        self.q = deque(maxlen=w)
    
    def update(self, x):
        self.q.append(x)
        return np.median(self.q)
```

**Особливості:** Нелінійний фільтр. Відмінно справляється з імпульсними викидами, зберігаючи різкі зміни траєкторії.

---

## Експеримент 1: Базові параметри

**Параметри:**
- `W_SMA = 20`
- `A_EMA = 0.1`
- `W_MED = 21`

<img width="1590" height="1989" alt="image" src="https://github.com/user-attachments/assets/49dc7cc8-12cf-4285-8c3b-cd5c9b8b3ad4" />

### Аналіз результатів

#### Графік 3 (Координата Y - Змійка, 13-20 с):
<img width="1631" height="455" alt="image" src="https://github.com/user-attachments/assets/f95ef757-e85c-47a2-adc0-9db50b4d6a68" />

**Затримка фільтрів:**
- Усі три фільтри демонструють помірну затримку на синусоїдальних коливаннях. При базових параметрах затримка становить приблизно 0.2-0.3 секунди, що є прийнятним для більшості застосувань.
- **SMA (синя лінія)** показує найбільшу затримку - особливо помітно на піках синусоїди (13-20 с), де лінія відстає від чорного пунктиру.
- **EMA (помаранчева лінія)** реагує швидше за SMA і краще слідкує за траєкторією. Це підтверджує теоретичну перевагу експоненційного згладжування - менша фазова затримка при порівнянному рівні шумопридушення.
- **Median (зелена лінія)** має затримку, подібну до SMA, оскільки використовує вікно аналогічного розміру (W=21).

**Поведінка на викидах:**
- Медіанний фільтр: демонструє найкращі результати з обробки імпульсних викидів. На графіку видно, що поодинокі різкі сірі піки (outliers) повністю відсутні на зеленій лінії - фільтр їх ефективно "ігнорує", оскільки медіана не чутлива до екстремальних значень.
- SMA: розмазує викиди на 3-5 точок вперед і назад. Це видно по невеликих "горбах" на синій лінії в місцях, де були викиди. Це є наслідком лінійного усереднення - викид впливає на всі точки у вікні.

---

## Експеримент 2: Екстремальне згладжування

**Параметри:**
- `W_SMA = 100` 
- `A_EMA = 0.02` 
- `W_MED = 21` 

<img width="1590" height="1989" alt="image" src="https://github.com/user-attachments/assets/1c60dc3f-f0a9-4a4b-8f7b-5ac2216860e6" />

### Аналіз спектру помилки (Графік 4b)
<img width="812" height="478" alt="image" src="https://github.com/user-attachments/assets/bfedc62b-55db-44c5-957a-635986e57644" />

#### Зона низьких частот (0-1 Гц):

**Спостереження:**
На графіку спектру помилки чітко видно **парадоксальний ефект**: синя (SMA) та помаранчева (EMA) лінії в зоні низьких частот (0-1 Гц) піднялися **значно вище** сірої лінії вхідного шуму! Зелена лінія (Median з W=21) залишилась майже на рівні сірої. Це означає, що хоча фільтри з W=100 відмінно придушили високочастотний шум (права частина графіка), вони створили нові, низькочастотні помилки, які за амплітудою **перевищують** оригінальний шум.

**Пояснення парадоксу:**

Це явище називається **динамічними спотвореннями** або **lag-induced error**:

1. **Механізм виникнення:**
   - При великому вікні фільтрації (W=100) фільтр "не встигає" за реальною траєкторією
   - На поворотах і синусоїдальних ділянках виникає систематична помилка - фільтр "зрізає кути"
   - Ця помилка має низькочастотний характер (повторюється з періодом маневру)

2. **Спектральний ефект:**
   - На високих частотах (>5 Гц): фільтр добре придушує шум
   - На низьких частотах (<1 Гц): з'являються **нові помилки** через затримку
   - Результат: загальна помилка може бути більшою, ніж вхідний шум!

3. **Практичний висновок:**
   Існує **критичний баланс** між згладжуванням та затримкою. Надмірне згладжування (W=100, α=0.02) призводить до того, що фільтр перестає відображати реальний рух об'єкта і починає генерувати власні спотворення. Для траєкторій з динамічними маневрами (повороти, синусоїди) оптимальне вікно становить W=15-30. При W>50 втрати від затримки починають перевищувати користь від шумопридушення. **Висновок:** більше згладжування ≠ кращий результат. Треба знаходити компроміс.

---

## Експеримент 3: Малий медіанний фільтр

**Параметри:**
- `W_SMA = 20`
- `A_EMA = 0.1`
- `W_MED = 5` 

<img width="1590" height="1989" alt="image" src="https://github.com/user-attachments/assets/68d95504-605d-4bb4-a969-4a5308a74972" />

### Аналіз

**Поведінка на викидах:**
- При W_MED=5 медіанний фільтр **успішно видаляє одиночні викиди** (1-2 точки), оскільки вони не можуть стати медіаною в вікні з 5 елементів.
- Проте, якщо викид триває 3+ точки підряд (що трапляється рідко при OUTLIER_PROB=0.02), він може частково проявитись, оскільки займає більшість вікна.
- На графіку видно, що зелена лінія (Median W=5) має кілька дрібних "неровностей", яких не було при W=21. Це і є прояв викидів, що тривають 2-3 точки.

**Гладкість траєкторії:**
- Median з W=5 виглядає помітно **більш "тремтливою"** порівняно з базовим W=21. Це очікувано - менше вікно означає меншу інерційність, але й менше згладжування Гауссового шуму.
- Порівняно з SMA(20), лінія Median(5) має приблизно вдвічі більшу амплітуду високочастотних коливань. Це компроміс: швидша реакція за рахунок збереження частини шуму.
- При цьому Median(5) все одно гладкіша за сирий вхідний сигнал (сірі точки).

**Висновок:**
- Оптимальний розмір вікна для медіанного фільтра залежить від **характеру викидів** у ваших даних:
  - Якщо викиди завжди одиночні (1-2 точки) → W=5-7 достатньо, і ви отримаєте швидку реакцію
  - Якщо можливі групові викиди (3-5 точок) → потрібно W=15-25 для надійного придушення
  - Якщо викиди рідкісні, але критичні (наприклад, GPS glitch) → краще взяти більше вікно (W=21-31)
- Також треба враховувати **динаміку об'єкта**: для швидких маневрів краще менше W, для плавного руху - більше W.

---

## Загальні висновки

### 1. Видалення збоїв сенсора (імпульсні викиди):

**Найкращий фільтр:** **Median Filter**

**Обґрунтування:**
- Медіанний фільтр має фундаментальну перевагу перед лінійними фільтрами (SMA, EMA) при роботі з імпульсними викидами завдяки своїй **нелінійній природі**.
- Принцип роботи: медіана не чутлива до екстремальних значень. Навіть якщо у вікні з 21 елемента є 3-4 викиди з амплітудою ±10м, медіана все одно обере значення з кластеру "нормальних" точок.
- SMA та EMA **розмазують** викиди на 5-10 сусідніх точок, створюючи артефакти, тоді як Median їх повністю видаляє.
- Експериментально підтверджено: при W=21 медіанний фільтр видалив 100% одиночних викидів без залишкових артефактів.

### 2. Плавне ведення траєкторії (мінімальна затримка):

**Найкращий фільтр:** **EMA (Exponential Moving Average)**

**Обґрунтування:**
- EMA демонструє найкращий **баланс між шумопридушенням та швидкістю реакції** на зміни траєкторії.
- Теоретично: EMA має меншу фазову затримку порівняно з SMA при однаковій ефективності згладжування. Формула α=2/(W+1) дає приблизну еквівалентність, але фазові характеристики різні.
- Практично підтверджено на Експерименті 1: помаранчева лінія (EMA) найточніше слідкує за чорним пунктиром на ділянці змійки (13-20с).
- Додаткова перевага: **O(1) пам'ять та обчислення** - критично для embedded систем (мікроконтролери, FPGA).
- На 2D траєкторії EMA показала найменше зрізання кутів при поворотах.

---

## Використані технології

- Google Colab
- Python 3.x
- NumPy - генерація даних та обчислення
- Matplotlib - візуалізація
- SciPy - спектральний аналіз (FFT)
